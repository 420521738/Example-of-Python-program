{% extends 'master/layout.html' %}

{% block css %}
	<link href='/static/css/modal.css' rel='stylesheet' type='text/css' />
{% endblock %}


{% block page-content %}

		<div>
			<p><span>您所在的房间号是：{{room_obj.name}}</span><input style="float:right;" type='button' onclick='fadeIn()' value='退出房间' /></p>
			<div>
				<div style="float:left;width:200px;">
					<ul>
						<h4>在线用户列表</h4>
						{% for item in member_list %}
						<li>{{item.user.username}}</li>
						{% endfor %}
					</ul>
				</div>
				<div style="float:left;width:400px;">
					<div id='chatpool' style="height:400px;width:400px;border:3px solid #ddd;overflow:auto;"></div>
					<br><br>
					<div>
						<textarea id='message' style="width:350px;height:50px;"></textarea>
						<input type='button' onclick='SendMsg();' value='发送' />
					</div>
				</div>
				<div sytle="clear:both;"></div>
			</div>
		</div>
		
		<div id='formTable' class='modal hide'>
			<form id='form0' method='POST' action='/delroomuser/{{room_obj.id}}/'>
				<div class='modal-header' style='height:40px'>
					<div style='float:left'><h4>{{user.username}}大人,您确定要退出房间吗？</h4></div>
					<div style='float:right'><a class='close' id='close' onclick='fadeOut()' style='cursor:pointer'>x</a></div>
				</div>
				
				<div class='modal-body'>
					<p>您不要离开，我会伤心的~~~</p>
					<p>欢迎您下次再来!</p>
				</div>
				
				<div class='modal-footer'>
					<input type='submit' onclick='fadeOut()' class='btn btn-success' value='提交' />
					<a onclick='fadeOut()' class='btn btn-success' data-dismiss='modal'>取消</a>
					<!-- 
					<a href='/' onclick='fadeOut()' class='btn btn-success'>提交</a>
					<a onclick='fadeOut()' class='btn btn-success' data-dismiss='modal'>取消</a>					
					 -->

				</div>
			</form>
		</div>
		
		<div id='shade' class='modal-background hide'></div>
		
{% endblock %}


{% block js %}
	<script type="text/javascript" src='/static/js/jquery-1.8.2.js'></script>
	<script>
		// 对Date的扩展，将 Date 转化为指定格式的String   
	    // 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，   
	    // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)   
	    // 例子：   
	    // (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423   
	    // (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18   
	    Date.prototype.Format = function(fmt)   
	    {
	      var o = {   
	        "M+" : this.getMonth()+1,                 //月份   
	        "d+" : this.getDate(),                    //日   
	        "h+" : this.getHours(),                   //小时   
	        "m+" : this.getMinutes(),                 //分   
	        "s+" : this.getSeconds(),                 //秒   
	        "q+" : Math.floor((this.getMonth()+3)/3), //季度   
	        "S"  : this.getMilliseconds()             //毫秒   
	      };   
	      if(/(y+)/.test(fmt))   
	        fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));   
	      for(var k in o)   
	        if(new RegExp("("+ k +")").test(fmt))   
	      fmt = fmt.replace(RegExp.$1, (RegExp.$1.length==1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));   
	      return fmt;   
	    }  
	
		function fadeIn(){
			document.getElementById('formTable').className='modal';
			document.getElementById('shade').className='modal-background';
			}
		function fadeOut(){
			document.getElementById('formTable').className='modal hide';
			document.getElementById('shade').className='modal-background hide';
			}
		function SendMsg(){
			var sendTime = new Date().Format("yyyy-MM-dd hh:mm:ss"); 
			//alert(sendTime);
			var msg = $('#message').val();
			$('#message').val("");
			var content = "<span>"+sendTime+"</span><br><span>"+msg+"</span><br>"
			$('#chatpool').append(content)
			var height = document.getElementById("chatpool").scrollHeight;
			$('#chatpool').scrollTop(height)
			var id ={{user.id}}
			var roomid = {{room_obj.id}}
			var data = {id:id,roomid:roomid,msg:msg,sendtime:sendTime}
			syncrequest('/savemsg/',data,'post',null)
			}

		setInterval(function(){
			var roomid = {{room_obj.id}}
			data = {roomid:roomid}
			syncrequest('/getmsg/',data,'get',updatechatpool)
		},2000);
		
		function updatechatpool(arg){
			var arg = $.parseJSON(arg);
			$("#chatpool").empty();
			console.log(arg);
			$.each(arg,function(k,v){
				var content = "<span>"+v[2]+"</span><br><span>"+v[1]+"</span><br>"
				$("#chatpool").append(content);
			})
		}
			
		function syncrequest(url,data,type,func){
			$.ajax({
				url:url,
				data:data,
				type:type,
				success:func
				})
			}
			
		$("#message").keyup(function(event){
			if(event.keyCode == 13){
				SendMsg();
			}
		})
	</script>
{% endblock %}